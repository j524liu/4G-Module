# 4G+GNSS模块配置：

###### VER 0.1, 2021/4/14, Author: LIU Jiajun

## 1.概览（系统中使用频率较高的配置项目）

| 配置内容             | 命令                                                         | 返回值            | 说明                                                         | 默认值                                                       |
| -------------------- | ------------------------------------------------------------ | ----------------- | :----------------------------------------------------------- | ------------------------------------------------------------ |
| DTU工作模式          | AT*WKMODE=&lt;mode&gt;#                                      | OK<br>ERROR       | <b>&lt;mode&gt;:</b><br>0 - AT命令模式<br>1 - 透传模式<br>X - 协议模式 | 1                                                            |
| DTU在线模式          | AT*GPRSMODE=&lt;mode&gt;#                                    | OK<br>ERROR       | <b>\<mode\>:</b><br>0 - 离线模式，不连接<br>1 - 永远在线，定时发送心跳包<br>2 - 唤醒在线，收到唤醒命令上线，无数据传输离线<br>3 - 按需在线，串口收到数据上线，无数据传输离线<br>4 - 周期在线，按配置周期自动上线、离线 | 1                                                            |
| DTU中心模式          | AT*CHMODE=&lt;mode&gt;#                                      | OK<br>ERROR       | <b>&lt;mode&gt;:</b><br>0 - 单主中心，只与主中心连接并传输数据<br>1 - 主备中心切换，优先连接主中心，不可用则连接备中心<br>2 - 主备中心同时连接，同时连接主备中心并传输数据，数据流量大 | 1                                                            |
| DTU调试模式          | AT*DBGMODE=&lt;mode&gt;#                                     | OK<br>ERROR       | <b>&lt;mode&gt;:</b><br>0 - 关闭调试，不输出调试信息<br>1 - 联网状态回显，输出联网状态<br>2 - TRACE模式，输出DTU运行TRACE信息<br>3 - 在线离线提示，输出连接到服务器或从服务器断开信息 | 0                                                            |
| DTU ID配置           | AT*DTUID=&lt;id&gt;#                                         | OK<br>ERROR       | <b>&lt;id&gt;:</b><br>默认为模块IMEI号，可按需设定设备ID，长度1至32字节 | 设备IMEI                                                     |
| 是否带ID上报数据     | AT*DATAID=&lt;n&gt;#                                         | OK<br>ERROR       | <b>&lt;n&gt;:</b><br>0 - 关闭<br>1 - 打开                    | 0                                                            |
| DTU电话号码          | AT*PHNO=&lt;phone_no&gt;#                                    | OK<br>ERROR       | <b>&lt;phone_no&gt;:</b><br>默认为空，可根据使用的SIM卡号配置DTU电话号码 | 空                                                           |


| 配置内容             | 命令                                                         | 返回值            | 说明                                                         | 默认值                                                       |
| -------------------- | ------------------------------------------------------------ | ----------------- | :----------------------------------------------------------- | ------------------------------------------------------------ |
| DTU串口参数          | AT*UART=&lt;baudrate&gt;,&lt;dataBits&gt;,<br>\<parity\>,\<stopBits\>,\<flowControl\> | OK<br>ERROR       | <b>\<baudrate\>:<br></b>UART波特率，支持1200,2400,4800,9600,14400,19200,<br>38400,57600,115200<br><b>\<dataBits\>:</b><br>数据位，支持5,6,7,8<br><b>\<parity>:</b><br>校验位，0 - 无，1 - 奇校验，2 - 偶校验，3 - 空格<br><b>\<stopBits\>:</b><br>停止位，支持1,2,3（1.5位）<br><b>\<flowControl\>:</b><br>串口流控，0 - 无，1 - 硬件流控，2 - 软件流控 | <b>\<baudrate\>:</b> 9600,<br><b>\<dataBits\>:</b> 8,<br><b>\<parity\>:</b> 0,<br><b>\<stopBits\>:</b> 1,<br><b>\<flowControl\>:</b> 0 |
| 串口数据包间隔时间   | AT*DFI=\<time\>#                                             | OK<br>ERROR       | <b>\<time\>:</b><br>透传及按数据帧分包发送时，小于此时间间隔的数据将作为一个数据包合并发送，范围：0-5000ms | 100ms                                                        |
| 心跳时间             | AT*HBTIME=\<time\>#                                          | OK<br>ERROR       | <b>\<time\>:</b><br>心跳时间间隔，范围：0-3600s              | 60s                                                          |
| 心跳包头             | AT*HBHEAD=\<head\>#                                          | OK<br>ERROR       | <b>\<head\>:</b><br>任意组合长度小于32字符的ASCII字符串，可为空，默认$$$ | $$$                                                          |
| 注册包模式           | AT*REGPKG=\<mode\>#                                          | OK<br>ERROR       | <b>\<mode\>:</b><br>0 - 关闭注册包<br>1 - 注册包 + DTUID<br>2 - 注册包（ASCII文本模式发送）<br>3 - 注册包（HEX形式发送）<br>n - 其他定制格式 | 1                                                            |
| 注册包               | AT*REGHEAD=\<text\>#                                         | OK<br>ERROR       | <b>\<text\>:</b><br>任意组合长度不超过64字符的ASCII字符串，可为空，默认@@@ | @@@                                                          |
| 主连接类型地址及端口 | AT*SERVER1=\<type\>,\<ip\>,\<port\>#                         | OK<br>ERROR       | <b>\<type\>:</b><br>0 - TCP RAW<br>1 - UDP RAW<br>2 - MODE NONE<br><b>\<ip\>:</b><br>主服务器地址，IP或域名<br><b>\<port\>:</b><br> 主服务器端口号 |                                                              |
| 副连接类型地址及端口 | AT*SERVER2=\<type\>,\<ip\>,\<port\>#                         | OK<br/>ERROR      | <b>\<type\>:</b><br/>0 - TCP RAW<br/>1 - UDP RAW<br/>2 - MODE NONE<br/><b>\<ip\>:</b><br/>副服务器地址，IP或域名<br/><b>\<port\>:</b><br/> 副服务器端口号 |                                                              |
| DTU唤醒命令          | AT*WAKEUP#                                                   | OK<br>ERROR       | 唤醒模式生效，收到命令后DTU启动数据连接请求                  |                                                              |
| DTU离线命令          | AT*OFFLINE#                                                  | OK<br>ERROR       | 按需模式或唤醒模式生效，收到命令后DTU主动断开连接并离线      |                                                              |
| 自动离线时间         | AT*IDLTIME=\<time\>#                                         | OK<br>ERROR       | <b>\<time\>:</b><br>DTU自动离线时间配置，范围：5-3600s       | 300s                                                         |
| 数据发送方式         | AT*DATAMD=\<mode\>#                                          | OK<br>ERROR       | <b>\<mode\>:</b><br>0 - 按数据流连续发送，不关心数据沾包问题<br>1 - 按数据帧分包发送，每帧不超过1024字节<br>2 - 按json格式包发送，串口数据固定格式打包<br>3 - 其他协议定制封包格式 | 0                                                            |
| GNSS工作模式         | AT*GPSCFG=\<mode\>,\<send_period\>#                          | OK<br>ERROR       | <b>\<mode\>:</b><br>0 - 关闭GNSS功能及信息发送<br>1 - 只向后台服务器发送GNSS信息<br>2 - 只向上位机发送GNSS信息<br>3 - 同时向服务器和上位机发送GNSS信息<br>4 - 不自动发送，收到读取指令时发送<br><b>\<send_period\>:</b><br>GNSS信息发送周期，范围：1-65535s，设为0则上电且定位成功后发送一次后关闭定位。 | 5s                                                           |
| GNSS信息查询         | AT*GPSINFO?                                                  | 定位信息（GPRMC） | 输出标准GPRMC格式定位信息                                    |                                                              |

## 2.细节

### 1. GPRMC格式详解

> 1. GPRMC标准格式：
>
>    $GPRMC ,\<1\>,\<2\>,\<3\>,\<4\>,\<5\>,\<6\>,\<7\>,\<8\>,\<9\>,\<10\>,\<11\>,\<12\>*hh
>
> 2. GPRMC参数说明：
>
>    <b>\<1\>:</b> UTC时间，格式：hhmmss.sss（时分秒.毫秒)<br><b>\<2\>:</b> 定位状态，A=有效定位，V=无效定位<br><b>\<3\>:</b> 纬度，格式：ddmm.mmmm<br><b>\<4\>:</b> 维度半球，N=北半球，S=南半球<br><b>\<5\>:</b> 经度，格式：ddmm.mmmm<br><b>\<6\>:</b> 经度半球，E=东经，W=西经<br><b>\<7\>:</b> 地面速率，格式：vvv.v，单位节，范围：000.0-999.9<br><b>\<8\>:</b> 地面航向，格式：ddd.d，以正北为参考基，范围：000.0-359.9<br><b>\<9\>:</b> UTC日期，格式：ddmmyy（日月年）<br><b>\<10\>:</b> 磁偏角，格式：ddd.d，范围：000.0-180.0<br><b>\<11\>:</b> 磁偏角方向，E=东，W=西<br><b>\<12\>:</b> 模式指示，A=自主定位，D=差分，E=估算，N=数据无效<br><b>hh:</b> 校验和，$到*所有字符的异或和

### 2. 关于项目使用4G+GNSS模块初始化参数

> #### 1. 参数
>
> ​		WKMODE=1
>
> ​		GPRSMODE=3
>
> ​		CHMODE=0
>
> ​		DBGMODE=0
>
> ​		DTUID为用户设置值，在初始化函数中设置
>
> ​		DATAID=0
>
> ​		PHNO=null
>
> ​		REGHEAD=0
>
> ​		SERVER1=0,49.232.152.70,3389
>
> ​		DATAMD=0
>
> ​		GPSCFG=4,0
>
> ​		其他参数使用默认值即可
>
> #### 2. 解释
>
> 		1. 模块通过TCP/UDP连接的方式与服务器通信，所以采用透传模式；
>   		2. 整个系统数据轮询时间有一定的随机性，加之对于低功耗需求的考虑，采用按需在线模式，数据轮询结束后唤醒模块发送数据，发送完成后下线，以降低系统功耗；
>   		3. 考虑到系统数据量不大，且出现瞬时数据涌的概率极低，采用单数据中心模式，以减小流量消耗；
>   		4. 系统上线后，应关闭调试功能，以防调试信息影响正常数据的接收处理；
>   		5. 设备ID是整个系统中设备的唯一身份标识，由管理人员统一分配，并由用户在初始化设备阶段录入；
>   		6. 数据传输采用自定义的数据包，包含了设备ID，无需开启带ID传输功能；
>   		7. 暂时不考虑电话远程唤醒设备功能，无需设置电话号。如后续由相关需求，可由用户自行设置；
>   		8. 系统与服务器数据交换量小，且需交换的数据类型相对单一，数据有效性可由服务器端判断，故关闭注册包功能，以减少流量开销；
>   		9. 主数据中心服务器IP地址为49.232.152.70，开放端口3389用于数据交换。整个通信流程采用SOCKET方式，模块与服务器直接建立TCP连接，故连接类型选择TCP RAW；
>   		10. 系统交换的数据量相对较小，且相邻数据包间的时间间隔较长，不会出现沾包问题，故直接采用数据流连续发送方式；
>   		11. GNSS工作模式选用不自动发送模式，防止模块频繁发送GNSS数据产生流量浪费并造成服务器端接受处理异常。